<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Eljan Guluyev's Personal Portfolio Tracker - Track your investments and wealth">
    <meta name="keywords" content="Eljan Guluyev, Portfolio Tracker, Investments, Wealth Management">
    <meta name="author" content="Eljan Guluyev">
    <title>Eljan's Portfolio Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <style>
        :root {
            --primary-color: #10a37f;
            --success-color: #10a37f;
            --danger-color: #ef4146;
            --background-color: #ffffff;
            --card-background: #ffffff;
            --text-primary: #202123;
            --text-secondary: #6e6e80;
            --border-color: #e5e5e5;
        }

        body {
            background-color: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Background Effects */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%),
                radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        /* Animated Background Elements */
        .bg-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }

        .bg-elements::before,
        .bg-elements::after {
            content: '';
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(59, 130, 246, 0.1));
            animation: float 20s infinite;
        }

        .bg-elements::before {
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .bg-elements::after {
            bottom: -150px;
            right: -150px;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(50px, 50px) rotate(90deg);
            }
            50% {
                transform: translate(0, 100px) rotate(180deg);
            }
            75% {
                transform: translate(-50px, 50px) rotate(270deg);
            }
        }

        /* Grid Pattern */
        .grid-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(37, 99, 235, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(37, 99, 235, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.5;
        }

        .portfolio-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .portfolio-card:hover {
            border-color: var(--primary-color);
        }

        .total-value {
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1rem 0;
        }

        .investment-item {
            border: 1px solid var(--border-color);
            background: var(--card-background);
            margin-bottom: 1rem;
            padding: 1.25rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .investment-item:hover {
            border-color: var(--primary-color);
        }

        .profit {
            color: var(--success-color);
            font-weight: 500;
        }

        .loss {
            color: var(--danger-color);
            font-weight: 500;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background: #0d8c6d;
        }

        .btn-outline-primary {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-outline-danger {
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background: var(--danger-color);
            color: white;
        }

        .modal-content {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .modal-header {
            border-bottom: 1px solid var(--border-color);
            padding: 1.25rem;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding: 1.25rem;
        }

        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 0.625rem 0.875rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }

        .table {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .table thead th {
            background-color: #f9f9f9;
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding: 0.875rem 1rem;
        }

        .table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }

        .table tbody tr:last-child {
            border-bottom: none;
        }

        .table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .table td {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
        }

        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            color: var(--text-primary);
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        .chart-container {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .login-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .admin-controls {
            display: none;
            gap: 0.5rem;
            align-items: center;
        }

        .view-only .admin-controls {
            display: none !important;
        }

        .admin-mode .admin-controls {
            display: flex;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .portfolio-card {
            animation: fadeIn 0.5s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .total-value {
                font-size: 2rem;
            }

            .investment-item {
                padding: 1rem;
            }

            .btn {
                padding: 0.5rem 1rem;
            }

            .admin-controls {
                flex-direction: column;
                width: 100%;
                margin-top: 1rem;
            }

            .admin-controls .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .d-flex.justify-content-between {
                flex-direction: column;
            }
        }

        /* Mobile-first base styles */
        body {
            padding: 1rem;
            max-width: 100%;
            overflow-x: hidden;
        }

        .container {
            padding: 0;
            max-width: 100%;
        }

        /* Mobile Header */
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 1rem;
        }

        .admin-controls {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .admin-controls .btn {
            width: 100%;
            margin: 0;
        }

        /* Mobile Cards */
        .portfolio-card {
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .total-value {
            font-size: 1.75rem;
            margin: 0.5rem 0;
        }

        /* Mobile Investment Items */
        .investment-item {
            padding: 1rem;
        }

        .investment-item .d-flex {
            flex-direction: column;
            gap: 0.5rem;
        }

        .investment-item .text-end {
            text-align: left !important;
            margin-top: 0.5rem;
        }

        /* Mobile Tables */
        .table-responsive {
            margin: 0 -1rem;
            padding: 0 1rem;
            width: calc(100% + 2rem);
        }

        .table {
            font-size: 0.875rem;
        }

        .table th, .table td {
            padding: 0.75rem;
            white-space: nowrap;
        }

        /* Mobile Charts */
        .chart-container {
            height: 250px;
            margin: 1rem -1rem;
            padding: 1rem;
        }

        /* Mobile Modals */
        .modal-dialog {
            margin: 1rem;
            max-width: calc(100% - 2rem);
        }

        .modal-body {
            padding: 1rem;
        }

        /* Mobile Forms */
        .form-control, .form-select {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 0.75rem;
            height: auto;
        }

        /* Mobile Login Button */
        .login-button {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            z-index: 1000;
        }

        /* Desktop Styles */
        @media (min-width: 768px) {
            body {
                padding: 2rem;
            }

            .container {
                padding: 0 1rem;
                max-width: 1200px;
            }

            .d-flex.justify-content-between {
                flex-direction: row;
                align-items: center;
            }

            .admin-controls {
                width: auto;
                flex-direction: row;
            }

            .admin-controls .btn {
                width: auto;
            }

            .portfolio-card {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .total-value {
                font-size: 2.5rem;
                margin: 1rem 0;
            }

            .investment-item {
                padding: 1.25rem;
            }

            .investment-item .d-flex {
                flex-direction: row;
                align-items: center;
            }

            .investment-item .text-end {
                text-align: right !important;
                margin-top: 0;
            }

            .table-responsive {
                margin: 0;
                padding: 0;
                width: 100%;
            }

            .table {
                font-size: 1rem;
            }

            .table th, .table td {
                padding: 1rem;
            }

            .chart-container {
                height: 300px;
                margin: 1.5rem 0;
                padding: 1.5rem;
            }

            .modal-dialog {
                margin: 1.75rem auto;
                max-width: 500px;
            }

            .modal-body {
                padding: 1.25rem;
            }

            .login-button {
                top: 1.5rem;
                right: 1.5rem;
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
        }

        /* Additional Mobile Improvements */
        @media (max-width: 767px) {
            .row {
                margin-left: -0.5rem;
                margin-right: -0.5rem;
            }

            .col, .col-md-6, .col-md-12 {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .card {
                margin-bottom: 1rem;
            }

            .card-body {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            h3 {
                font-size: 1.25rem;
            }

            .btn {
                padding: 0.75rem;
                font-size: 0.875rem;
            }

            .text-muted {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>Eljan's Portfolio</h1>
                <p class="text-muted mb-0">Track your investments and wealth</p>
            </div>
            <div class="admin-controls">
                <button class="btn btn-outline-primary me-2" onclick="exportData()">Export Data</button>
                <button class="btn btn-outline-primary me-2" onclick="importData()">Import Data</button>
                <button class="btn btn-outline-danger" onclick="handleLogout()">Logout</button>
            </div>
        </div>
        
        <!-- Total Portfolio Value -->
        <div class="portfolio-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3>Total Portfolio Value</h3>
                    <div class="total-value" id="totalValue">$0.00</div>
                    <p class="text-muted mb-0">Last updated: <span id="lastUpdated">-</span></p>
                </div>
                <div class="admin-controls">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInvestmentModal">
                        + Add Investment
                    </button>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="portfolio-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Portfolio Distribution</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Section -->
        <div class="portfolio-card p-4 mb-4">
            <h3 class="mb-4">Portfolio Data</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Performance Metrics</h5>
                            <div id="performanceMetrics">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Asset Allocation</h5>
                            <div id="assetAllocation">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Investment History</h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Quantity</th>
                                            <th>Initial Investment</th>
                                            <th>Current Value</th>
                                            <th>Profit/Loss</th>
                                            <th>Return %</th>
                                            <th>Date Added</th>
                                        </tr>
                                    </thead>
                                    <tbody id="investmentHistory">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Investments List -->
        <div class="portfolio-card p-4">
            <h3 class="mb-4">My Investments</h3>
            <div id="investmentsList">
                <!-- Investments will be added here -->
            </div>
        </div>
    </div>

    <!-- Add Investment Modal -->
    <div class="modal fade" id="addInvestmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Investment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="investmentForm">
                        <div class="mb-3">
                            <label class="form-label">Investment Name</label>
                            <input type="text" class="form-control" id="investmentName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="investmentType" required onchange="toggleQuantityField()">
                                <option value="stock">Stock</option>
                                <option value="crypto">Cryptocurrency</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3" id="quantityGroup">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" step="0.000001" required>
                        </div>
                        <div class="mb-3" id="acquisitionPriceGroup">
                            <label class="form-label">Acquisition Price per Unit ($)</label>
                            <input type="number" class="form-control" id="acquisitionPrice" step="0.01" required>
                            <small class="text-muted">The price you paid for each unit (share/coin)</small>
                        </div>
                        <div class="mb-3" id="currentPriceGroup">
                            <label class="form-label">Current Price per Unit ($)</label>
                            <input type="number" class="form-control" id="currentPrice" step="0.01" required>
                            <small class="text-muted">The current market price for each unit</small>
                        </div>
                        <div class="mb-3" id="totalAmountGroup">
                            <label class="form-label">Total Amount Invested ($)</label>
                            <input type="text" class="form-control" id="totalAmount" readonly>
                            <small class="text-muted">Automatically calculated (Quantity × Acquisition Price)</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addInvestment()">Add Investment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Investment Modal -->
    <div class="modal fade" id="updateInvestmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Investment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateInvestmentForm">
                        <div class="mb-3">
                            <label class="form-label">Transaction Type</label>
                            <select class="form-select" id="transactionType" required onchange="updateTotalCalculation()">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="updateQuantity" step="0.000001" required onchange="updateTotalCalculation()">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price per Unit ($)</label>
                            <input type="number" class="form-control" id="updatePrice" step="0.01" required onchange="updateTotalCalculation()">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Transaction Amount ($)</label>
                            <input type="text" class="form-control" id="updateTotalAmount" readonly>
                            <small class="text-muted">Automatically calculated (Quantity × Price per Unit)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="updateDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateInvestment()">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this before the closing </body> tag -->
    <input type="file" id="importFile" style="display: none" accept=".json" onchange="handleFileImport(event)">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Authentication configuration
        const AUTH_CONFIG = {
            username: 'admin',
            password: 'eljn_0siksok12',
            tokenKey: 'portfolio_auth_token'
        };

        let investments = [];
        let distributionChart = null;
        let currentUpdateIndex = -1;

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadInvestments();
        });

        // Handle logout
        function handleLogout() {
            localStorage.removeItem(AUTH_CONFIG.tokenKey);
            window.location.href = 'admin.html';
        }

        // Check authentication status
        function checkAuth() {
            const token = localStorage.getItem(AUTH_CONFIG.tokenKey);
            if (token) {
                document.body.classList.add('admin-mode');
                document.body.classList.remove('view-only');
            } else {
                window.location.href = 'admin.html';
            }
        }

        // Load investments from data.json
        async function loadInvestments() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error('Failed to load data');
                }
                const data = await response.json();
                investments = data.investments || [];
                updateInvestmentsList();
                updateCharts();
            } catch (error) {
                console.error('Error loading investments:', error);
                alert('Failed to load investments. Please refresh the page.');
                investments = [];
                updateInvestmentsList();
                updateCharts();
            }
        }

        // Save investments to data.json
        async function saveInvestments() {
            try {
                const data = {
                    investments: investments,
                    lastUpdated: new Date().toISOString(),
                    version: "1.0"
                };

                const response = await fetch('data.json', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data, null, 2)
                });

                if (!response.ok) {
                    throw new Error('Failed to save data');
                }

                console.log('Save successful');
                return true;
            } catch (error) {
                console.error('Error saving investments:', error);
                alert(`Failed to save changes: ${error.message}`);
                return false;
            }
        }

        // Add event listeners for automatic total calculation
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('quantity');
            const acquisitionPriceInput = document.getElementById('acquisitionPrice');
            const totalAmountInput = document.getElementById('totalAmount');

            function updateTotalAmount() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(acquisitionPriceInput.value) || 0;
                const total = quantity * price;
                totalAmountInput.value = total.toFixed(2);
            }

            quantityInput.addEventListener('input', updateTotalAmount);
            acquisitionPriceInput.addEventListener('input', updateTotalAmount);
        });

        // Toggle quantity and price fields based on investment type
        function toggleQuantityField() {
            const type = document.getElementById('investmentType').value;
            const quantityGroup = document.getElementById('quantityGroup');
            const acquisitionPriceGroup = document.getElementById('acquisitionPriceGroup');
            const currentPriceGroup = document.getElementById('currentPriceGroup');
            const totalAmountGroup = document.getElementById('totalAmountGroup');
            
            if (type === 'other') {
                quantityGroup.style.display = 'none';
                acquisitionPriceGroup.style.display = 'none';
                currentPriceGroup.style.display = 'none';
                totalAmountGroup.style.display = 'none';
            } else {
                quantityGroup.style.display = 'block';
                acquisitionPriceGroup.style.display = 'block';
                currentPriceGroup.style.display = 'block';
                totalAmountGroup.style.display = 'block';
            }
        }

        // Add new investment
        async function addInvestment() {
            try {
                const name = document.getElementById('investmentName').value;
                const type = document.getElementById('investmentType').value;
                const quantity = type !== 'other' ? parseFloat(document.getElementById('quantity').value) : null;
                const acquisitionPrice = type !== 'other' ? parseFloat(document.getElementById('acquisitionPrice').value) : null;
                const currentPrice = type !== 'other' ? parseFloat(document.getElementById('currentPrice').value) : null;

                if (type !== 'other' && (isNaN(quantity) || isNaN(acquisitionPrice) || isNaN(currentPrice))) {
                    throw new Error('Please enter valid numbers for all fields');
                }

                const investment = {
                    name,
                    type,
                    quantity,
                    acquisitionPrice,
                    currentPrice,
                    amount: type !== 'other' ? quantity * acquisitionPrice : 0,
                    currentValue: type !== 'other' ? quantity * currentPrice : 0,
                    dateAdded: new Date().toISOString()
                };

                investments.push(investment);
                const saveSuccess = await saveInvestments();
                
                if (saveSuccess) {
                    updateInvestmentsList();
                    updateCharts();
                    
                    // Close modal and reset form
                    const addInvestmentModal = bootstrap.Modal.getInstance(document.getElementById('addInvestmentModal'));
                    addInvestmentModal.hide();
                    document.getElementById('investmentForm').reset();
                    document.getElementById('totalAmount').value = '';
                } else {
                    // Remove the investment if save failed
                    investments.pop();
                }
            } catch (error) {
                console.error('Error adding investment:', error);
                alert(error.message || 'Failed to add investment. Please try again.');
            }
        }

        // Show update modal
        function showUpdateModal(index) {
            currentUpdateIndex = index;
            const investment = investments[index];
            document.getElementById('updateQuantity').value = '';
            document.getElementById('updatePrice').value = '';
            document.getElementById('updateTotalAmount').value = '';
            document.getElementById('updateDate').value = new Date().toISOString().split('T')[0];
            
            const modal = new bootstrap.Modal(document.getElementById('updateInvestmentModal'));
            modal.show();
        }

        // Update total calculation
        function updateTotalCalculation() {
            const quantity = parseFloat(document.getElementById('updateQuantity').value) || 0;
            const price = parseFloat(document.getElementById('updatePrice').value) || 0;
            const total = quantity * price;
            document.getElementById('updateTotalAmount').value = total.toFixed(2);
        }

        // Update investment
        async function updateInvestment() {
            try {
                const index = currentUpdateIndex;
                if (index === -1) return;

                const type = document.getElementById('transactionType').value;
                const quantity = parseFloat(document.getElementById('updateQuantity').value);
                const price = parseFloat(document.getElementById('updatePrice').value);
                const date = document.getElementById('updateDate').value;

                if (isNaN(quantity) || isNaN(price)) {
                    throw new Error('Please enter valid numbers for quantity and price');
                }

                const investment = investments[index];
                const newQuantity = type === 'buy' 
                    ? investment.quantity + quantity 
                    : investment.quantity - quantity;

                if (newQuantity < 0) {
                    throw new Error(`Cannot sell more ${investment.type === 'crypto' ? 'coins' : 'shares'} than owned`);
                }

                // Calculate new average price for buy transactions
                if (type === 'buy') {
                    const totalCost = (investment.amount) + (price * quantity);
                    investment.amount = totalCost;
                    investment.acquisitionPrice = totalCost / newQuantity;
                } else {
                    // For sell transactions, reduce the total amount proportionally
                    const sellRatio = quantity / investment.quantity;
                    investment.amount -= investment.amount * sellRatio;
                }

                investment.quantity = newQuantity;
                investment.currentPrice = price; // Update current price to the latest transaction price
                investment.currentValue = investment.quantity * investment.currentPrice;

                // Add transaction to history
                if (!investment.transactions) {
                    investment.transactions = [];
                }
                investment.transactions.push({
                    type,
                    quantity,
                    price,
                    date,
                    totalAmount: quantity * price
                });

                const saveSuccess = await saveInvestments();
                
                if (saveSuccess) {
                    updateInvestmentsList();
                    updateCharts();
                    
                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('updateInvestmentModal'));
                    modal.hide();
                    document.getElementById('updateInvestmentForm').reset();
                    document.getElementById('updateTotalAmount').value = '';
                }
            } catch (error) {
                console.error('Error updating investment:', error);
                alert(error.message || 'Failed to update investment. Please try again.');
            }
        }

        // Update investments list
        function updateInvestmentsList() {
            const investmentsList = document.getElementById('investmentsList');
            investmentsList.innerHTML = '';

            investments.forEach((investment, index) => {
                const profit = investment.currentValue - investment.amount;
                const profitPercentage = (profit / investment.amount) * 100;
                const profitClass = profit >= 0 ? 'profit' : 'loss';
                const unitType = investment.type === 'crypto' ? 'coins' : 'shares';

                const investmentElement = document.createElement('div');
                investmentElement.className = 'investment-item';
                investmentElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">${investment.name}</h5>
                            <small class="text-muted">
                                ${investment.type}
                                ${investment.quantity ? ` • ${investment.quantity.toFixed(6)} ${unitType}` : ''}
                                ${investment.acquisitionPrice ? ` • Avg. Price: $${investment.acquisitionPrice.toFixed(2)} per ${unitType.slice(0, -1)}` : ''}
                                ${investment.currentPrice ? ` • Current: $${investment.currentPrice.toFixed(2)} per ${unitType.slice(0, -1)}` : ''}
                            </small>
                        </div>
                        <div class="text-end">
                            <div class="h5 mb-1">$${investment.currentValue.toFixed(2)}</div>
                            <div class="${profitClass}">
                                ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)} (${profitPercentage.toFixed(1)}%)
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 admin-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="showUpdateModal(${index})">
                            Update Investment
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeInvestment(${index})">
                            Remove
                        </button>
                    </div>
                `;
                investmentsList.appendChild(investmentElement);
            });

            updateTotalValue();
        }

        // Remove investment
        async function removeInvestment(index) {
            try {
                if (confirm('Are you sure you want to remove this investment?')) {
                    const removedInvestment = investments[index];
                    investments.splice(index, 1);
                    
                    const saveSuccess = await saveInvestments();
                    
                    if (saveSuccess) {
                        updateInvestmentsList();
                        updateCharts();
                    } else {
                        // Restore the investment if save failed
                        investments.splice(index, 0, removedInvestment);
                    }
                }
            } catch (error) {
                console.error('Error removing investment:', error);
                alert('Failed to remove investment. Please try again.');
            }
        }

        // Update total portfolio value
        function updateTotalValue() {
            const total = investments.reduce((sum, investment) => sum + investment.currentValue, 0);
            const totalInvested = investments.reduce((sum, investment) => sum + investment.amount, 0);
            const totalProfit = total - totalInvested;
            const totalProfitPercentage = (totalInvested > 0) ? (totalProfit / totalInvested) * 100 : 0;
            const profitClass = totalProfit >= 0 ? 'profit' : 'loss';

            document.getElementById('totalValue').innerHTML = `
                $${total.toFixed(2)}<br>
                <small class="${profitClass}">
                    ${totalProfit >= 0 ? '+' : ''}$${totalProfit.toFixed(2)} (${totalProfitPercentage.toFixed(1)}%)
                </small>
            `;

            // Update last updated timestamp
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleString();
        }

        // Update performance metrics
        function updatePerformanceMetrics() {
            const total = investments.reduce((sum, inv) => sum + inv.currentValue, 0);
            const totalInvested = investments.reduce((sum, inv) => sum + inv.amount, 0);
            const totalProfit = total - totalInvested;
            const totalReturn = (totalProfit / totalInvested) * 100;
            
            const bestPerformer = [...investments].sort((a, b) => {
                const aReturn = (a.currentValue - a.amount) / a.amount;
                const bReturn = (b.currentValue - b.amount) / b.amount;
                return bReturn - aReturn;
            })[0];

            const worstPerformer = [...investments].sort((a, b) => {
                const aReturn = (a.currentValue - a.amount) / a.amount;
                const bReturn = (b.currentValue - b.amount) / b.amount;
                return aReturn - bReturn;
            })[0];

            document.getElementById('performanceMetrics').innerHTML = `
                <div class="mb-2">
                    <strong>Total Return:</strong> 
                    <span class="${totalProfit >= 0 ? 'profit' : 'loss'}">
                        ${totalProfit >= 0 ? '+' : ''}$${totalProfit.toFixed(2)} (${totalReturn.toFixed(1)}%)
                    </span>
                </div>
                <div class="mb-2">
                    <strong>Best Performer:</strong> 
                    ${bestPerformer ? `
                        ${bestPerformer.name} 
                        <span class="profit">
                            +${((bestPerformer.currentValue - bestPerformer.amount) / bestPerformer.amount * 100).toFixed(1)}%
                        </span>
                    ` : 'N/A'}
                </div>
                <div class="mb-2">
                    <strong>Worst Performer:</strong> 
                    ${worstPerformer ? `
                        ${worstPerformer.name} 
                        <span class="loss">
                            ${((worstPerformer.currentValue - worstPerformer.amount) / worstPerformer.amount * 100).toFixed(1)}%
                        </span>
                    ` : 'N/A'}
                </div>
            `;
        }

        // Update asset allocation
        function updateAssetAllocation() {
            const allocation = investments.reduce((acc, inv) => {
                acc[inv.type] = (acc[inv.type] || 0) + inv.currentValue;
                return acc;
            }, {});

            const total = Object.values(allocation).reduce((sum, val) => sum + val, 0);

            document.getElementById('assetAllocation').innerHTML = Object.entries(allocation)
                .map(([type, value]) => `
                    <div class="mb-2">
                        <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong>
                        $${value.toFixed(2)} (${((value / total) * 100).toFixed(1)}%)
                    </div>
                `).join('');
        }

        // Update investment history table
        function updateInvestmentHistory() {
            const tbody = document.getElementById('investmentHistory');
            tbody.innerHTML = investments.map(inv => {
                const profit = inv.currentValue - inv.amount;
                const returnPercent = (profit / inv.amount) * 100;
                const date = new Date(inv.dateAdded).toLocaleDateString();

                return `
                    <tr>
                        <td>${inv.name}</td>
                        <td>${inv.type}</td>
                        <td>${inv.quantity ? inv.quantity.toFixed(6) : 'N/A'}</td>
                        <td>$${inv.amount.toFixed(2)}</td>
                        <td>$${inv.currentValue.toFixed(2)}</td>
                        <td class="${profit >= 0 ? 'profit' : 'loss'}">
                            ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}
                        </td>
                        <td class="${profit >= 0 ? 'profit' : 'loss'}">
                            ${profit >= 0 ? '+' : ''}${returnPercent.toFixed(1)}%
                        </td>
                        <td>${date}</td>
                    </tr>
                `;
            }).join('');
        }

        // Update all data sections
        function updateDataSections() {
            updatePerformanceMetrics();
            updateAssetAllocation();
            updateInvestmentHistory();
        }

        // Update charts
        function updateCharts() {
            updateDistributionChart();
            updateDataSections();
        }

        // Update distribution chart
        function updateDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }

            const data = {
                labels: investments.map(inv => inv.name),
                datasets: [{
                    data: investments.map(inv => inv.currentValue),
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                        '#5a5c69', '#858796', '#6f42c1', '#20c9a6', '#fd7e14'
                    ]
                }]
            };

            distributionChart = new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Export data to JSON file
        function exportData() {
            try {
                const data = {
                    investments: investments,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Failed to export data. Please try again.');
            }
        }

        // Import data from JSON file
        function importData() {
            document.getElementById('importFile').click();
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data || !Array.isArray(data.investments)) {
                        throw new Error('Invalid data format');
                    }

                    if (confirm('This will replace your current portfolio data. Are you sure?')) {
                        investments = data.investments;
                        saveInvestments();
                        updateInvestmentsList();
                        updateCharts();
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Failed to import data. Please make sure the file is valid.');
                }
                // Reset the file input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        // Add backup functionality
        function createBackup() {
            try {
                const backup = {
                    investments: investments,
                    backupDate: new Date().toISOString()
                };
                localStorage.setItem('portfolio_backup', JSON.stringify(backup));
                console.log('Backup created successfully');
            } catch (error) {
                console.error('Error creating backup:', error);
            }
        }

        // Restore from backup
        function restoreFromBackup() {
            try {
                const backup = localStorage.getItem('portfolio_backup');
                if (!backup) {
                    alert('No backup found');
                    return;
                }

                const data = JSON.parse(backup);
                if (!data || !Array.isArray(data.investments)) {
                    throw new Error('Invalid backup format');
                }

                if (confirm('This will restore your portfolio from the last backup. Are you sure?')) {
                    investments = data.investments;
                    saveInvestments();
                    updateInvestmentsList();
                    updateCharts();
                    alert('Backup restored successfully!');
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
                alert('Failed to restore backup. Please try again.');
            }
        }
    </script>
</body>
</html>
